# Guardian OS - Build Family ISO
# Builds per-FAMILY ISO (not per-child)
# One ISO works for all children in the family
# Child selection happens at boot time via Guardian Selector

name: Build Family ISO

on:
  workflow_dispatch:
    inputs:
      build_id:
        description: 'Build ID from Supabase'
        required: true
        type: string
      family_id:
        description: 'Family UUID'
        required: true
        type: string
      family_name:
        description: 'Family name (sanitized for tags)'
        required: true
        type: string
      device_type:
        description: 'Device type'
        required: true
        type: choice
        options:
          - desktop
          - deck
          - tablet
      public_key:
        description: 'Family public key for verification'
        required: true
        type: string
      callback_url:
        description: 'Supabase callback URL'
        required: true
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: guardian-network/guardian-os

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout Guardian OS
        uses: actions/checkout@v4
        with:
          repository: guardian-network/guardian-games-os
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate build timestamp
        id: timestamp
        run: echo "timestamp=$(date +%Y%m%d-%H%M%S)" >> $GITHUB_OUTPUT

      # =========================================================================
      # CREATE FAMILY CONFIG (minimal - just identity)
      # =========================================================================
      - name: Create family config
        run: |
          mkdir -p build/config
          
          # Minimal config - NO child profiles, NO settings
          # Everything fetched from cloud at runtime
          cat > build/config/guardian.yaml << 'EOF'
          # Guardian OS - Family Configuration
          # This file is baked into the ISO and identifies this device's family
          # All child profiles and settings are fetched from Supabase at runtime

          guardian:
            version: "2.0.0"
            
            # Family identity (immutable)
            family:
              id: "${{ inputs.family_id }}"
              build_id: "${{ inputs.build_id }}"
              
            # Verification key (for activation signature)
            verification:
              algorithm: "ES256"
              public_key: |
          ${{ inputs.public_key }}
              
            # API configuration
            api:
              supabase_url: "${{ secrets.SUPABASE_URL }}"
              supabase_anon_key: "${{ secrets.SUPABASE_ANON_KEY }}"
              
            # Build metadata
            build:
              timestamp: "${{ steps.timestamp.outputs.timestamp }}"
              device_type: "${{ inputs.device_type }}"
              base_image: "ghcr.io/ublue-os/bazzite:stable"
          EOF
          
          # Indent the public key properly
          sed -i 's/^-----/        -----/g' build/config/guardian.yaml

      # =========================================================================
      # BUILD GUARDIAN COMPONENTS
      # =========================================================================
      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: guardian-components

      - name: Build Guardian Daemon
        run: |
          cd guardian-components/guardian-daemon
          cargo build --release
          mkdir -p ../../build/bin
          cp target/release/guardian-daemon ../../build/bin/

      - name: Build Guardian Selector
        run: |
          cd guardian-components/guardian-selector
          cargo build --release
          cp target/release/guardian-selector ../../build/bin/

      # =========================================================================
      # BUILD GUARDIAN LAUNCHER (Electron)
      # =========================================================================
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build Guardian Launcher
        run: |
          cd guardian-launcher
          npm ci
          npm run build
          mkdir -p ../build/launcher
          cp -r dist/* ../build/launcher/

      # =========================================================================
      # CREATE CONTAINERFILE
      # =========================================================================
      - name: Create Containerfile
        run: |
          cat > Containerfile << 'EOF'
          # Guardian OS - Family Edition
          # Based on Bazzite (Fedora Atomic + Gaming)
          
          FROM ghcr.io/ublue-os/bazzite:stable
          
          # Labels
          LABEL org.opencontainers.image.title="Guardian OS"
          LABEL org.opencontainers.image.description="Family-safe gaming OS"
          LABEL org.opencontainers.image.vendor="Guardian Network Solutions"
          LABEL io.guardian.family_id="${{ inputs.family_id }}"
          LABEL io.guardian.build_id="${{ inputs.build_id }}"
          LABEL io.guardian.device_type="${{ inputs.device_type }}"
          
          # Guardian config (family identity)
          COPY build/config/guardian.yaml /etc/guardian/config.yaml
          RUN chmod 644 /etc/guardian/config.yaml
          
          # Guardian binaries
          COPY build/bin/guardian-daemon /usr/bin/guardian-daemon
          COPY build/bin/guardian-selector /usr/bin/guardian-selector
          RUN chmod 755 /usr/bin/guardian-daemon /usr/bin/guardian-selector
          
          # Guardian Launcher
          COPY build/launcher /opt/guardian-launcher
          RUN ln -sf /opt/guardian-launcher/guardian-launcher /usr/bin/guardian-launcher
          
          # Systemd services
          
          # Guardian Selector (runs BEFORE display manager, handles child selection)
          RUN cat > /etc/systemd/system/guardian-selector.service << 'SERVICE'
          [Unit]
          Description=Guardian OS Child Selector
          After=systemd-user-sessions.service
          Before=display-manager.service
          Wants=network-online.target
          
          [Service]
          Type=oneshot
          ExecStart=/usr/bin/guardian-selector
          RemainAfterExit=yes
          StandardInput=tty
          StandardOutput=tty
          TTYPath=/dev/tty1
          
          [Install]
          WantedBy=graphical.target
          SERVICE
          
          # Guardian Daemon (background service)
          RUN cat > /etc/systemd/system/guardian-daemon.service << 'SERVICE'
          [Unit]
          Description=Guardian OS Daemon
          After=guardian-selector.service network-online.target
          Requires=guardian-selector.service
          
          [Service]
          Type=simple
          ExecStart=/usr/bin/guardian-daemon
          Restart=always
          RestartSec=5
          
          [Install]
          WantedBy=multi-user.target
          SERVICE
          
          # Enable services
          RUN systemctl enable guardian-selector.service
          RUN systemctl enable guardian-daemon.service
          
          # Guardian Launcher autostart (after login)
          RUN mkdir -p /etc/xdg/autostart
          RUN cat > /etc/xdg/autostart/guardian-launcher.desktop << 'DESKTOP'
          [Desktop Entry]
          Type=Application
          Name=Guardian Launcher
          Exec=/usr/bin/guardian-launcher
          X-GNOME-Autostart-enabled=true
          DESKTOP
          
          # Security: Prevent modification of Guardian files
          RUN chattr +i /etc/guardian/config.yaml || true
          RUN chattr +i /usr/bin/guardian-daemon || true
          RUN chattr +i /usr/bin/guardian-selector || true
          
          # OSTree commit
          RUN ostree container commit
          EOF

      # =========================================================================
      # BUILD OCI IMAGE
      # =========================================================================
      - name: Build OCI Image
        run: |
          podman build \
            --tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ inputs.family_name }}-${{ steps.timestamp.outputs.timestamp }} \
            --tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ inputs.family_name }}-latest \
            -f Containerfile \
            .

      - name: Push OCI Image
        run: |
          podman push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ inputs.family_name }}-${{ steps.timestamp.outputs.timestamp }}
          podman push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ inputs.family_name }}-latest

      # =========================================================================
      # GENERATE ISO (using bootc-image-builder)
      # =========================================================================
      - name: Generate ISO
        run: |
          mkdir -p output
          
          # Use bootc-image-builder to create bootable ISO
          podman run \
            --rm \
            --privileged \
            --pull=newer \
            -v ./output:/output \
            quay.io/centos-bootc/bootc-image-builder:latest \
            --type iso \
            --rootfs btrfs \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ inputs.family_name }}-latest
          
          # Rename ISO
          mv output/*.iso output/guardian-os-${{ inputs.family_name }}-${{ inputs.device_type }}.iso

      - name: Calculate ISO checksum
        id: checksum
        run: |
          ISO_FILE="output/guardian-os-${{ inputs.family_name }}-${{ inputs.device_type }}.iso"
          SHA256=$(sha256sum "$ISO_FILE" | cut -d' ' -f1)
          SIZE=$(stat -c%s "$ISO_FILE")
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          echo "size=$SIZE" >> $GITHUB_OUTPUT

      # =========================================================================
      # UPLOAD ISO TO R2/S3
      # =========================================================================
      - name: Upload ISO to R2
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          command: r2 object put guardian-builds/guardian-os-${{ inputs.build_id }}.iso --file=output/guardian-os-${{ inputs.family_name }}-${{ inputs.device_type }}.iso

      - name: Generate presigned URL
        id: presign
        run: |
          # Generate presigned URL valid for 7 days
          # This would use your R2/S3 SDK
          echo "iso_url=https://builds.guardian-os.com/guardian-os-${{ inputs.build_id }}.iso" >> $GITHUB_OUTPUT

      # =========================================================================
      # NOTIFY SUPABASE
      # =========================================================================
      - name: Notify Supabase - Success
        if: success()
        run: |
          curl -X PATCH "${{ inputs.callback_url }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/json" \
            -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
            -d '{
              "status": "ready",
              "iso_url": "${{ steps.presign.outputs.iso_url }}",
              "iso_sha256": "${{ steps.checksum.outputs.sha256 }}",
              "iso_size_bytes": ${{ steps.checksum.outputs.size }},
              "oci_image": "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ inputs.family_name }}-latest",
              "build_completed_at": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
            }'

      - name: Notify Supabase - Failure
        if: failure()
        run: |
          curl -X PATCH "${{ inputs.callback_url }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/json" \
            -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
            -d '{
              "status": "failed",
              "error_message": "Build failed - check GitHub Actions logs"
            }'
