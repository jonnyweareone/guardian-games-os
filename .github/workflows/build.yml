name: Build Guardian Games OS

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - '.github/ISSUE_TEMPLATE/**'
  pull_request:
    paths-ignore:
      - '**.md'
  schedule:
    # Build daily at 15:00 UTC (after Bazzite builds complete)
    - cron: '0 15 * * *'
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild even if no changes'
        required: false
        default: 'false'

env:
  IMAGE_NAME: guardian-games
  IMAGE_REGISTRY: ghcr.io/${{ github.repository_owner }}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref || github.run_id }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: self-hosted
    permissions:
      contents: write
      packages: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check disk space
        run: df -h

      - name: Login to GHCR
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | sudo podman login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Build Container Image
        run: |
          sudo podman build \
            --build-arg BASE_IMAGE=bazzite \
            --build-arg BAZZITE_TAG=stable \
            --build-arg IMAGE_NAME=${{ env.IMAGE_NAME }}-main \
            --build-arg IMAGE_TAG=main \
            -t ${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:main \
            -t ${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:main-$(date +%Y%m%d) \
            -f ./Containerfile .

      - name: Push Container Image
        if: github.event_name != 'pull_request'
        run: |
          sudo podman push ${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:main
          sudo podman push ${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:main-$(date +%Y%m%d)

      - name: Print Installation Instructions
        run: |
          echo ""
          echo "=============================================="
          echo "  Guardian Games OS Container Built!"
          echo "=============================================="
          echo ""
          echo "To install on a Bazzite/Fedora Atomic system:"
          echo ""
          echo "  rpm-ostree rebase ostree-unverified-image:docker://${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:main"
          echo "  systemctl reboot"
          echo ""
          echo "Or use the signed image:"
          echo ""
          echo "  rpm-ostree rebase ostree-image-signed:docker://${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:main"
          echo ""
          echo "=============================================="

      - name: Cleanup
        if: always()
        run: |
          sudo podman system prune -f || true
