name: Build Guardian Games OS

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - '.github/ISSUE_TEMPLATE/**'
  pull_request:
    paths-ignore:
      - '**.md'
  schedule:
    # Build daily at 15:00 UTC (after Bazzite builds complete)
    - cron: '0 15 * * *'
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild even if no changes'
        required: false
        default: 'false'
      build_iso:
        description: 'Build ISO after container'
        required: false
        default: 'true'

env:
  IMAGE_NAME: guardian-games
  IMAGE_REGISTRY: ghcr.io/${{ github.repository_owner }}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref || github.run_id }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: self-hosted
    permissions:
      contents: write
      packages: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check disk space
        run: df -h

      - name: Login to GHCR
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | podman login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Build Container Image
        run: |
          podman build \
            --build-arg BASE_IMAGE=bazzite \
            --build-arg BAZZITE_TAG=stable \
            --build-arg IMAGE_NAME=${{ env.IMAGE_NAME }}-main \
            --build-arg IMAGE_TAG=main \
            -t ${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:main \
            -t ${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:main-$(date +%Y%m%d) \
            -f ./Containerfile .

      - name: Push Container Image
        if: github.event_name != 'pull_request'
        run: |
          podman push ${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:main
          podman push ${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:main-$(date +%Y%m%d)

      - name: Generate ISO with bootc
        if: github.event_name != 'pull_request' && (github.event.inputs.build_iso == 'true' || github.event.inputs.build_iso == '')
        id: iso
        run: |
          ISO_NAME="guardian-games-os-$(date +%Y%m%d).iso"
          
          # Create output directory
          mkdir -p ./iso-output
          
          # Use bootc to generate ISO from container
          sudo podman run --rm --privileged \
            --security-opt label=type:unconfined_t \
            -v ./iso-output:/output \
            -v /var/lib/containers/storage:/var/lib/containers/storage \
            quay.io/centos-bootc/bootc-image-builder:latest \
            --type iso \
            --rootfs ext4 \
            --local \
            ${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:main
          
          # Find the generated ISO
          ISO_PATH=$(find ./iso-output -name "*.iso" -type f | head -1)
          
          if [ -z "$ISO_PATH" ]; then
            echo "ERROR: No ISO found in output"
            ls -la ./iso-output/
            exit 1
          fi
          
          # Rename to our standard name
          mv "$ISO_PATH" "./iso-output/${ISO_NAME}"
          
          echo "iso_name=${ISO_NAME}" >> $GITHUB_OUTPUT
          echo "iso_path=./iso-output/${ISO_NAME}" >> $GITHUB_OUTPUT
          ls -lh "./iso-output/${ISO_NAME}"

      - name: Upload ISO as artifact
        if: steps.iso.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: guardian-games-os-iso
          path: ${{ steps.iso.outputs.iso_path }}
          retention-days: 30

      - name: Create/Update Release
        if: steps.iso.outcome == 'success'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Create or update the latest release
          gh release view latest 2>/dev/null && gh release delete latest -y || true
          gh release create latest \
            --title "Guardian Games OS - Latest Build" \
            --notes "Built on $(date +%Y-%m-%d)
          
          ## Download
          - **guardian-games-os.iso** - Bootable installer
          
          ## Installation
          1. Download the ISO
          2. Flash to USB with Balena Etcher or similar
          3. Boot from USB
          4. Follow the installer
          5. On first boot, link your device to your Guardian account
          " \
            --latest
          
          # Upload the ISO
          gh release upload latest "${{ steps.iso.outputs.iso_path }}" --clobber

      - name: Cleanup
        if: always()
        run: |
          sudo rm -rf ./iso-output || true
          podman system prune -f || true
